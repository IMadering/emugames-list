<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EmuGames List</title>
<meta name="description" content="Retro games catalog – screenshots, descriptions and gameplay videos." />
<meta name="keywords" content="game catalog, retro games, gaming systems" />
<meta name="robots" content="index, follow" />
<meta property="og:title" content="EmuGames List" />
<meta property="og:description" content="Retro games catalog – screenshots, descriptions and gameplay videos." />
<meta property="og:type" content="website" />
<style>
  :root{
    --bg:#0b0b0d; --panel:#0f1113; --muted:#9aa0a6; --accent:#7dd3fc;
    --card:#111316; --gap:14px; font-family: Inter, Roboto, Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#070708 0%, #0b0b0d 100%);color:#e6eef6}
  .wrap{max-width:1100px;margin:18px auto;padding:18px;display:grid;grid-template-columns:260px 1fr;gap:18px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:18px}
  .panel{background:var(--panel);border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.6)}
  .search{width:100%;padding:10px;border-radius:8px;border:1px solid #222;background:#0b0b0b;color:#e6eef6}
  /* Специальные стили для SELECT */
  #system-select{appearance:none; padding-right:30px;}
  #game-list{height:60vh;overflow:auto;padding:10px}
  .game-item{padding:10px;border-radius:8px;margin-bottom:8px;background:var(--card);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .game-item:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.6)}
  .meta{color:var(--muted);font-size:13px;margin-top:6px}
  #details{padding:12px;height:76vh;overflow:auto}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;background:#0e1112;border:1px solid rgba(255,255,255,.03);cursor:pointer}
  .tab.active{background:linear-gradient(90deg,#08303c,#0b4a55);color:#fff}
  
  /* Стили для карусели скриншотов */
  #screenshot-carousel { position: relative; width: 100%; max-width: 600px; margin: 0 auto; }
  .screenshot-item { display: none; } /* Скрываем все, кроме активного */
  .screenshot-item.active { display: block; }

  .screens img{max-width:100%;border-radius:8px;display:block;box-shadow:0 8px 20px rgba(0,0,0,.6); cursor:pointer;}
  
  .carousel-control {
    position: absolute; top: 50%; transform: translateY(-50%); 
    background: rgba(0, 0, 0, 0.5); color: white; border: none; 
    padding: 10px; cursor: pointer; z-index: 10; font-size: 24px;
    line-height: 1; border-radius: 4px; user-select: none;
  }
  #prev-btn { left: 10px; }
  #next-btn { right: 10px; }
  
  .info-row{margin-bottom:8px}
  iframe{width:100%;height:360px;border-radius:8px;border:0;background:#000}
  .no-data{color:var(--muted);padding:12px}
  @media(max-width:900px){
    .wrap{grid-template-columns:1fr; padding:10px}
    #game-list{height:220px}
    #details{height:auto}
    #screenshot-carousel { max-width: 100%; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Retro games catalog</h1>
      <div style="color:var(--muted);font-size:13px">Screenshots · Descriptions · Gameplay</div>
    </header>

    <aside class="panel">
      <div style="margin-bottom:10px">
        <label style="color:var(--muted);font-size:13px" for="system-select">Systems</label>
        <select id="system-select" class="search" style="margin-top:8px"></select>
      </div>

      <div style="margin-bottom:10px">
        <label style="color:var(--muted);font-size:13px">Search Games</label>
        <input id="search" class="search" placeholder="By title..." />
      </div>

      <div style="margin-top:8px">
        <label style="color:var(--muted);font-size:13px">Games</label>
        <div id="game-list" style="margin-top:8px"></div>
      </div>
    </aside>

    <main class="panel" id="details">
      <div id="placeholder">
        <div class="no-data">Select a system and a game on the left — then switch between Screenshots / Info / Gameplay.</div>
      </div>

      <div id="game-area" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px">
          <div>
            <div id="game-title" style="font-weight:700;font-size:18px"></div>
            <div id="game-sub" class="meta"></div>
          </div>
        </div>

        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="screens">Screenshots</div>
          <div class="tab" data-tab="info">Info</div>
          <div class="tab" data-tab="youtube">Gameplay</div>
        </div>

        <div id="tab-screens">
            <div id="screenshot-carousel">
                <div class="screens" id="screens-list">
                    </div>
                <button id="prev-btn" class="carousel-control" style="display:none;">&#10094;</button>
                <button id="next-btn" class="carousel-control" style="display:none;">&#10095;</button>
            </div>
            <div id="screens-empty" class="no-data" style="text-align:center;display:none;margin-top:20px;">Screenshots not found.</div>
        </div>

        <div id="tab-info" style="display:none">
          <div id="info-area"></div>
        </div>

        <div id="tab-youtube" style="display:none">
          <div id="youtube-area"></div>
        </div>
      </div>

    </main>
  </div>

<script>
/* === INI parser (simple, robust for our INI shape) === */
function parseIni(text){
  const result = {}; let section = null;
  // Обработка разных типов переноса строк и BOM
  text = text.replace(/\ufeff/g, '').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const lines = text.split('\n');
  
  for (let raw of lines){
    const line = raw.trim();
    if (!line || line.startsWith(';') || line.startsWith('#')) continue;
    
    const sect = line.match(/^\[(.+?)\]$/);
    if (sect){
      section = sect[1];
      result[section] = {};
      continue;
    }
    
    if (!section) continue; 
    const kv = line.split('=');
    if (kv.length >= 2){
      const key = kv[0].trim();
      const val = kv.slice(1).join('=').trim();
      result[section][key] = val;
    }
  }
  return result;
}

/* === utils to fetch INI files from Systems/ (UTF-16 LE BOM SUPPORT) === */
async function fetchIniFile(path){
  try{
    const r = await fetch(path, {cache:'no-cache'});
    if (!r.ok) {
        if (!path.includes('Games.ini') && !path.includes('Emulators.ini') && !path.includes('Demos.ini')) {
             console.error(`INI file loading error: ${path}. Status: ${r.status}`);
        }
        return null;
    }
    
    const buffer = await r.arrayBuffer();
    const decoder = new TextDecoder('utf-16le');
    const txt = decoder.decode(buffer); 

    return parseIni(txt);
  }catch(e){
    console.error(`Critical error reading or parsing ${path}:`, e);
    return null;
  }
}

/* === load systems and populate UI === */
const systemSelectEl = document.getElementById('system-select'); 
const gameListEl = document.getElementById('game-list');
const searchInput = document.getElementById('search');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');

let allGames = [];
let shownGames = [];
let currentGame = null;
let currentScreenshots = []; 
let currentScreenIndex = 0; 

// Параметры для GitHub API, основанные на вашем URL
const GITHUB_USERNAME = 'imadering';
const GITHUB_REPO_NAME = 'emugames-list';

async function init(){
  const systems = await fetchIniFile('Systems.ini');
  systemSelectEl.innerHTML = '';
  if (!systems || Object.keys(systems).length === 0){
    systemSelectEl.innerHTML = '<option disabled selected>Systems.ini not found or empty</option>';
    return;
  }
  
  const names = Object.keys(systems);
  let firstDir = null;

  for (let i=0;i<names.length;i++){
    const sec = names[i];
    const dir = systems[sec]['Dir'] || sec; 
    const option = document.createElement('option');
    option.value = dir;
    option.textContent = sec;
    systemSelectEl.appendChild(option);
    
    if (i === 0) {
      firstDir = dir;
      option.selected = true;
    }
  }

  systemSelectEl.addEventListener('change', (e) => {
    loadGamesForSystem(e.target.value);
  });
  
  prevBtn.addEventListener('click', () => changeScreenshot(-1));
  nextBtn.addEventListener('click', () => changeScreenshot(1));


  if (firstDir) {
    loadGamesForSystem(firstDir);
  }
}

/* === load and merge Games.ini / Emulators.ini / Demos.ini === */
async function loadGamesForSystem(systemDir){
  const candidates = [
    { file: `Systems/${encodeURIComponent(systemDir)}/Games.ini`, source: 'Games' },
    { file: `Systems/${encodeURIComponent(systemDir)}/Emulators.ini`, source: 'Emulators' },
    { file: `Systems/${encodeURIComponent(systemDir)}/Demos.ini`, source: 'Demos' }
  ];
  const merged = {};
  
  for (const { file, source } of candidates){
    const data = await fetchIniFile(file);
    if (!data) continue;
    
    for (const sec of Object.keys(data)){
      // Ключ для слияния - гарантирует уникальность и хранит источник
      const uniqueKey = `${source}||${sec}`; 
      // Добавляем источник в объект игры
      merged[uniqueKey] = { ...data[sec], __source: source }; 
    }
  }
  
  // Преобразуем объект с объединенными данными в массив игр
  const arr = Object.values(merged).map(obj => {
    const Name = obj['Name'] || obj['NAME'] || obj['name'] || '';
    const Dir = obj['Dir'] || obj['DIR'] || obj['dir'] || '';
    const Year = obj['Year'] || obj['year'] || '';
    const Rating = obj['Rating'] || obj['rating'] || '';
    const Comment = obj['Comment'] || obj['COMMENT'] || '';
    const Found = obj['Found'] || obj['found'] || '';
    const Source = obj['__source'] || 'Games'; 
    
    return { Name, Dir, Year, Rating, Comment, Found, Source };
  });

  allGames = arr.map((g, idx) => ({
    id: idx,
    name: g.Name,
    dir: g.Dir, 
    year: g.Year,
    rating: g.Rating,
    comment: g.Comment,
    found: g.Found,
    source: g.Source 
  })).filter(g => g.name || g.dir); 
  
  console.log(`Loaded ${allGames.length} games for system ${systemDir}`);

  renderGameList();
}

/* === render games and search === */
function renderGameList(){
  const q = (searchInput.value||'').toLowerCase();
  shownGames = allGames.filter(g => (g.name||'').toLowerCase().includes(q));
  gameListEl.innerHTML = '';
  if (shownGames.length===0){
    gameListEl.innerHTML = '<div class="no-data">No games found.</div>';
    return;
  }
  
  if (currentGame && !shownGames.find(g => g.id === currentGame.id)) {
      showPlaceholder();
  }
  
  for (const g of shownGames){
    const el = document.createElement('div');
    el.className = 'game-item';
    el.innerHTML = `<div style="font-weight:600">${escapeHtml(g.name)}</div>
      <div class="meta">${escapeHtml(g.dir)} ${g.year ? ' • ' + g.year : ''} ${g.rating ? ' • ⭐'+g.rating : ''}</div>`;
    el.onclick = () => showGame(g);
    gameListEl.appendChild(el);
  }
}

function showPlaceholder(){
    document.getElementById('placeholder').style.display='block';
    document.getElementById('game-area').style.display='none';
    prevBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    currentGame = null;
}

/* === show game details (tabs, screenshots, info, youtube) === */
function showGame(g){
  currentGame = g;
  document.getElementById('placeholder').style.display='none';
  document.getElementById('game-area').style.display='block';
  document.getElementById('game-title').textContent = g.name || '(No Name)';
  document.getElementById('game-sub').textContent = `${g.dir || ''} • Source: ${g.source} ${g.year ? ' • ' + g.year : ''}`;
  
  // INFO TAB
  const info = document.getElementById('info-area');
  info.innerHTML = `
    <div class="info-row"><strong>Title:</strong> ${escapeHtml(g.name)}</div>
    <div class="info-row"><strong>Directory:</strong> ${escapeHtml(g.dir)}</div>
    <div class="info-row"><strong>Source File:</strong> ${escapeHtml(g.source)}.ini</div>
    <div class="info-row"><strong>Year / Rating:</strong> ${escapeHtml(g.year || '—')} / ⭐${escapeHtml(g.rating || '—')}</div>
    <div class="info-row"><strong>Found:</strong> ${escapeHtml(g.found || '—')}</div>
    <div class="info-row"><strong>Comment:</strong> ${escapeHtml(g.comment || '')}</div>
  `;

  // YOUTUBE TAB
  const yt = document.getElementById('youtube-area');
  const q = encodeURIComponent((g.name || '') + ' gameplay');
  yt.innerHTML = `<iframe src="https://www.youtube.com/embed?listType=search&list=${q}" allowfullscreen></iframe>`;
  
  // SCREENS TAB (Карусель)
  loadScreenshots(g);
}

// ====================================================================
// ИСПРАВЛЕННАЯ ФУНКЦИЯ ЗАГРУЗКИ СКРИНШОТОВ С GITHUB API
// ====================================================================
async function loadScreenshots(g) {
  const screensList = document.getElementById('screens-list');
  screensList.innerHTML = '';
  currentScreenshots = [];
  currentScreenIndex = 0;

  const folderName = g.dir; 
  const sourceBase = g.source || 'Games'; 
  const currentSystemDir = systemSelectEl.value; 

  if (!folderName || !currentSystemDir) {
      document.getElementById('screens-empty').textContent = 'Screenshots not found (Empty Dir).';
      document.getElementById('screens-empty').style.display = 'block';
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      return;
  }
  
  // 1. Формируем путь к папке в репозитории: Systems/{SystemDir}/{Games|Emulators|Demos}/{GameDir}
  const repoPath = `Systems/${currentSystemDir}/${sourceBase}/${folderName}`;
  
  // 2. Формируем URL для GitHub API
  const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}/contents/${encodeURIComponent(repoPath)}`;
  
  // 3. Загружаем список файлов с помощью fetch
  try {
      const response = await fetch(apiUrl);
      
      // Обработка ошибок
      if (response.status === 404) {
          document.getElementById('screens-empty').textContent = `Screenshots folder not found in GitHub: ${repoPath}`;
          document.getElementById('screens-empty').style.display = 'block';
          return;
      }
      if (!response.ok) throw new Error(`GitHub API error! Status: ${response.status}`);
      
      const contents = await response.json(); 
      
      // 4. Фильтруем файлы по типу и расширению (.jpg или .png)
      const imageFiles = contents
          .filter(item => 
              item.type === 'file' && 
              (item.name.toLowerCase().endsWith('.jpg') || item.name.toLowerCase().endsWith('.png'))
          )
          .sort((a, b) => a.name.localeCompare(b.name)); // Сортируем по имени файла
      
      if (imageFiles.length > 0) {
          document.getElementById('screens-empty').style.display = 'none';
          
          imageFiles.forEach((item) => {
              // URL для прямого доступа к файлу
              // Используем item.download_url или raw.githubusercontent.com
              const rawUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}/main/${item.path}`;

              const img = new Image();
              img.className = 'screenshot-item';
              img.src = rawUrl;
              img.onclick = () => window.open(rawUrl, '_blank');
              
              currentScreenshots.push({ path: item.path, element: img });
              screensList.appendChild(img);
          });
          
          currentScreenIndex = 0;
          updateScreenshotDisplay();

      } else {
          document.getElementById('screens-empty').textContent = 'Screenshots not found (0 files with .jpg or .png).';
          document.getElementById('screens-empty').style.display = 'block';
          prevBtn.style.display = 'none';
          nextBtn.style.display = 'none';
      }

  } catch (error) {
      console.error("Failed to fetch screenshot list from GitHub API:", error);
      document.getElementById('screens-empty').textContent = 'Error loading screenshot list from GitHub API.';
      document.getElementById('screens-empty').style.display = 'block';
  }
}
// ====================================================================

function updateScreenshotDisplay() {
    const screens = document.querySelectorAll('#screens-list .screenshot-item');
    screens.forEach((el, index) => {
        el.style.display = (index === currentScreenIndex) ? 'block' : 'none';
    });

    if (currentScreenshots.length > 1) {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
    } else {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    }
}

function changeScreenshot(delta) {
    if (currentScreenshots.length === 0) return;
    
    currentScreenIndex += delta;
    
    if (currentScreenIndex < 0) {
        currentScreenIndex = currentScreenshots.length - 1;
    } else if (currentScreenIndex >= currentScreenshots.length) {
        currentScreenIndex = 0;
    }
    
    updateScreenshotDisplay();
}

/* === simple tab handling === */
document.getElementById('tabs').addEventListener('click', (e)=>{
  const t = e.target.closest('.tab');
  if (!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tabName = t.dataset.tab;
  document.getElementById('tab-screens').style.display = tabName==='screens' ? 'block' : 'none';
  document.getElementById('tab-info').style.display = tabName==='info' ? 'block' : 'none';
  document.getElementById('tab-youtube').style.display = tabName==='youtube' ? 'block' : 'none';
  
  const isScreensTab = tabName === 'screens' && currentScreenshots.length > 1;
  prevBtn.style.display = isScreensTab ? 'block' : 'none';
  nextBtn.style.display = isScreensTab ? 'block' : 'none';
});

/* === search handler === */
searchInput.addEventListener('input', () => renderGameList());

/* === utils === */
function escapeHtml(s){
  if (!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* === init on page load === */
init();
</script>

</body>
</html>
